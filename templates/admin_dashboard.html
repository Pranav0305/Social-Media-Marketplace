{% extends "layout.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block head %}
  <!-- Include CSRF token meta for AJAX calls -->
  <meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block content %}
<h2>Admin Dashboard</h2>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <p class="{% if category == 'danger' %}text-danger{% else %}text-success{% endif %}">
                {{ message }}
            </p>
        {% endfor %}
    {% endif %}
{% endwith %}

<a href="{{ url_for('admin.logout') }}" style="float: right; background-color: red; color: white; padding: 5px 10px; text-decoration: none;">Logout</a>
<a href="{{ url_for('admin.admin_view_posts') }}" 
   style="display: inline-block; background-color: #007BFF; color: white; padding: 8px 16px; text-decoration: none; margin-bottom: 1rem; border-radius: 4px;">
   Manage Posts
</a>
<a href="{{ url_for('admin.secure_logs') }}" 
   style="display: inline-block; background-color: #28a745; color: white; padding: 8px 16px; text-decoration: none; margin-bottom: 1rem; border-radius: 4px;">
   View Secure Logs
</a>
<a href="{{ url_for('admin.verify_log_integrity') }}" 
   style="display: inline-block; background-color: #ffc107; color: black; padding: 8px 16px; text-decoration: none; margin-bottom: 1rem; border-radius: 4px;">
   Verify Log Integrity
</a>
<a href="{{ url_for('admin.flagged_posts') }}" 
   style="display: inline-block; background-color: #ffc107; color: black; padding: 8px 16px; text-decoration: none; margin-bottom: 1rem; border-radius: 4px;">
   View Flagged Posts
</a>


<table border="1" cellpadding="5">
    <tr>
        <th>Email</th>
        <th>Username</th>
        <th>Document</th>
        <th>Status</th>
        <th>Actions</th>
        <th>Delete</th>
    </tr>
    {% for user in users %}
    <tr id="user-row-{{ user._id }}">
        <td>{{ user.email }}</td>
        <td>{{ user.username }}</td>
        <td>
            {% if user.document and user.document != "" %}
                <a href="{{ url_for('admin.view_document', document_id=user.document) }}" target="_blank">View Document</a>
            {% else %}
                <span style="color: red;">No Document</span>
            {% endif %}
        </td>
        <td id="status-{{ user._id }}">{{ user.status }}</td>
        <td id="action-{{ user._id }}">
            {% if user.status == 'pending' %}
                <button class="approve-btn" data-url="{{ url_for('admin.approve_user', user_id=user._id) }}" data-userid="{{ user._id }}">Approve</button>
                <button class="reject-btn" data-url="{{ url_for('admin.reject_user', user_id=user._id) }}" data-userid="{{ user._id }}" style="background-color: red; color: white;">Reject</button>
            {% else %}
                <strong>{{ user.status | capitalize }}</strong>
            {% endif %}
        </td>
        <td>
            <!-- Delete button for user removal -->
            <button class="delete-btn" data-url="{{ url_for('admin.delete_user', user_id=user._id) }}" data-userid="{{ user._id }}" style="background-color: darkred; color: white;">Delete</button>
        </td>
    </tr>
    {% endfor %}
</table>

<script src="{{ url_for('static', filename='js/admin_dashboard.js') }}"></script>
{% endblock %}
