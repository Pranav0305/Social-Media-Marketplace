{% extends "layout.html" %}
{% block title %}Group Messaging{% endblock %}

{% block content %}
    {% if not session.get('user_id') %}
        <h2>You need to log in first.</h2>
        <p>To send or view messages, please <a href="{{ url_for('auth.login') }}">log in</a> or <a href="{{ url_for('auth.register') }}">register</a>.</p>
    {% else %}
        <h2>Group Messaging</h2>

        <!-- Show available groups -->
        <h3>Your Groups</h3>
        {% if groups %}
            <form method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label>Select Group:</label> 
                <select name="group_name" required>
                    <option value="" disabled selected>-- Select a Group --</option>
                    {% for group in groups %}
                        <option value="{{ group['name'] }}">{{ group['name'] }}</option>
                    {% endfor %}
                </select><br>
                <label>Message:</label> 
                <textarea name="message" required></textarea><br>
                <label>Media File (optional):</label>
                <input type="file" name="media"><br>
                <input type="submit" value="Send Message">
            </form>
        {% else %}
            <p>You are not a member of any groups. <a href="{{ url_for('group_messaging.create_group') }}">Create a group</a></p>
        {% endif %}

        <h3>Group Messages</h3>
        <ul>
            {% for msg in messages %}
            <li>
                <strong>From:</strong> {{ msg.sender_username }} |
                <strong>Group:</strong> {{ msg.group_name }}<br>
                <strong>Message:</strong> {{ msg.message }}<br>
                {% if msg.media_file %}
                    <strong>Media:</strong>
                    {% if msg.media_type and 'image' in msg.media_type %}
                        <img src="{{ url_for('group_messaging.serve_media', file_id=msg.media_file) }}" alt="Media" width="200">
                    {% else %}
                        <a href="{{ url_for('group_messaging.serve_media', file_id=msg.media_file) }}" target="_blank">View File</a>
                    {% endif %}
                    <br>
                {% endif %}
                <form action="{{ url_for('group_messaging.group_chain') }}" method="GET" target="_blank">
                    <button type="submit">View Blockchain Integrity</button>
                </form>
            </li>
            {% endfor %}
        </ul>
    {% endif %}
{% endblock %}
