{% extends "layout.html" %}
{% block title %}Direct Messaging{% endblock %}

{% block content %}
    {% if not session.get('user_id') %}
        <h2>You need to log in first.</h2>
        <p>To send or view messages, please <a href="{{ url_for('auth.login') }}">log in</a> or <a href="{{ url_for('auth.register') }}">register</a>.</p>
    {% else %}
        <h2>Direct Messaging</h2>
        <p>
            <a href="{{ url_for('group_messaging.group_messages') }}">
                <button>Go to Group Messaging</button>
            </a>
        </p>
        <p>
            <a href="{{ url_for('group_messaging.create_group') }}">
                <button>Create a New Group</button>
            </a>
        </p>
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
            <label>Recipient Username:</label> 
            <input type="text" name="recipient" required><br>
        
            <label>Message:</label> 
            <textarea name="message" required></textarea><br>
        
            <label>Media File (optional):</label>
            <input type="file" name="media"><br>
        
            <input type="submit" value="Send Message">
        </form>
        
        <h3>Your Messages</h3>
        <ul>
            {% for msg in messages %}
            <li>
                <strong>From:</strong> {{ msg.sender_username }} |
                <strong>To:</strong> {{ msg.recipient_username }}<br>
                <strong>Message:</strong> {{ msg.message }}<br>
                {% if msg.media_file %}
                    <strong>Media:</strong>
                    {% if msg.media_type and 'image' in msg.media_type %}
                        <img src="{{ url_for('messaging.serve_media', file_id=msg.media_file) }}" alt="Media" width="200">
                    {% else %}
                        <a href="{{ url_for('messaging.serve_media', file_id=msg.media_file) }}" target="_blank">View File</a>
                    {% endif %}
                    <br>
                {% endif %}
                <form action="{{ url_for('messaging.get_chain') }}" method="GET" target="_blank">
                    <button type="submit">View Blockchain Integrity</button>
                </form>
            </li>
            {% endfor %}
        </ul>
    {% endif %}
{% endblock %}
