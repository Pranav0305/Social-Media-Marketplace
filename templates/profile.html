{% extends "layout.html" %}
{% block title %}Profile{% endblock %}

{% block content %}
    {% if not user %}
        <h2>You need to log in first.</h2>
        <p><a href="{{ url_for('auth.login') }}">Login here</a> or <a href="{{ url_for('auth.register') }}">Register</a></p>
    {% else %}
        {% if is_own_profile %}
            <h2>Welcome, {{ user.username }}!</h2>
        {% else %}
            <h2>{{ user.username }}'s Profile</h2>
        {% endif %}

        <p>Email: {{ user.email }}</p>
        <p>Status: <strong>{{ user.status }}</strong></p>

        <!-- Profile Picture -->
        <p>
            {% if user.profile.profile_picture %}
            <img src="{{ url_for('profile_bp.uploaded_file', filename=user.profile.profile_picture) }}" width="150" alt="Profile Picture">
            {% else %}
            <img src="{{ url_for('static', filename='default_profile.jpeg') }}" width="150" alt="Default Profile Picture">
            {% endif %}
        </p>

        <!-- Bio -->
        <p><strong>Bio:</strong> {{ user.profile.bio or "No bio available." }}</p>

        {% if is_own_profile %}
            <!-- Friend Requests -->
            {% if friend_requests %}
                <h3>Friend Requests</h3>
                <ul>
                {% for req in friend_requests %}
                    <li>
                        {{ req.sender_username }}
                        <form method="POST" action="{{ url_for('profile_bp.accept_friend_request', request_id=req.request_id) }}" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit">Accept</button>
                        </form>
                        <form method="POST" action="{{ url_for('profile_bp.reject_friend_request', request_id=req.request_id) }}" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit">Reject</button>
                        </form>                        
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p>No new friend requests.</p>
            {% endif %}

            <!-- Friends List -->
            <h3>Your Friends</h3>
            {% if friends|length > 0 %}
                <ul>
                {% for friend in friends %}
                    <li>
                        <a href="{{ url_for('profile_bp.profile_view', user_id=friend._id) }}">{{ friend.username }}</a>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p>You donâ€™t have any friends yet.</p>
            {% endif %}

            <!-- Edit Profile Form -->
            <h3>Edit Profile</h3>
            <form id="editProfileForm" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label for="bio">Bio:</label>
                <textarea id="bio" name="bio">{{ user.profile.bio }}</textarea><br><br>

                <label for="profile_picture">Upload Profile Picture:</label>
                <input type="file" id="profile_picture" name="profile_picture" accept=".png, .jpg, .jpeg"><br><br>

                <button type="submit">Update Profile</button>
            </form>

            <!-- Registration Document -->
            {% if user.document %}
                <h3>Uploaded Registration Document</h3>
                <p><a href="{{ url_for('profile_bp.view_document', document_id=user.document) }}" target="_blank">View Document</a></p>
            {% else %}
                <p>No registration document uploaded.</p>
            {% endif %}

            <!-- My Posts -->
            <h3>My Posts</h3>
            <p><a href="{{ url_for('profile_bp.view_user_posts', user_id=user._id) }}">View Your Posts</a></p>

        {% else %}
            <!-- Friends of Other User -->
            <h3>{{ user.username }}'s Friends</h3>
            {% if friends|length > 0 %}
                <ul>
                {% for friend in friends %}
                    <li>
                        <a href="{{ url_for('profile_bp.profile_view', user_id=friend._id) }}">{{ friend.username }}</a>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p>No friends to display.</p>
            {% endif %}

            <!-- Social Actions -->
            <h3>Social Actions</h3>
            <form method="POST" action="{{ url_for('profile_bp.send_friend_request', user_id=user._id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit">Send Friend Request</button>
            </form>            
            <br>
            <form method="POST" action="{{ url_for('profile_bp.block_user', user_id=user._id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" onclick="return confirm('Are you sure you want to block this user?')">Block User</button>
            </form>            
            <br>
            <form method="POST" action="{{ url_for('profile_bp.report_user', user_id=user._id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label for="reason">Report Reason:</label><br>
                <textarea name="reason" rows="3" cols="40" placeholder="Enter reason..."></textarea><br>
                <button type="submit">Report User</button>
            </form>

            <!-- Posts by This User -->
            <h3>{{ user.username }}'s Posts</h3>
            <p><a href="{{ url_for('profile_bp.view_user_posts', user_id=user._id) }}">View Posts</a></p>
        {% endif %}
    {% endif %}

    <script src="{{ url_for('static', filename='js/edit_profile.js') }}"></script>
{% endblock %}
