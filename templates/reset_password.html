<h2>Enter OTP to Reset Password</h2>

<form method="POST" id="otpForm" onsubmit="return validatePassword()">
    <!-- OTP input (read-only, only via virtual keyboard) -->
    <label for="otpInput">OTP:</label>
    <input type="text" id="otpInput" name="otp" placeholder="Enter OTP" readonly maxlength="6"
           style="font-size: 18px; padding: 8px;" required />

    <!-- New password -->
    <label for="password">New Password:</label>
    <input type="password" id="password" name="password" onkeyup="checkPasswordStrength()" required style="padding: 8px;"><br>

    <!-- Password Rules -->
    <div id="password-rules">
        <p>Password must contain:</p>
        <ul>
            <li id="length-rule" style="color:red;">✅ At least 8 characters</li>
            <li id="uppercase-rule" style="color:red;">✅ One uppercase letter (A-Z)</li>
            <li id="lowercase-rule" style="color:red;">✅ One lowercase letter (a-z)</li>
            <li id="number-rule" style="color:red;">✅ One number (0-9)</li>
            <li id="special-rule" style="color:red;">✅ One special character (!@#$%^&*)</li>
        </ul>
    </div>

    <!-- Virtual Keyboard -->
    <div id="keyboard" style="margin-top: 15px;">
        {% for row in [0, 1, 2] %}
            <div style="margin-bottom: 5px;">
                {% for col in [1, 2, 3] %}
                    {% set digit = row * 3 + col %}
                    <button type="button" onclick="appendDigit('{{ digit }}')">{{ digit }}</button>
                {% endfor %}
            </div>
        {% endfor %}
        <div>
            <button type="button" onclick="clearInput()">Clear</button>
            <button type="button" onclick="appendDigit('0')">0</button>
            <button type="button" onclick="backspace()">←</button>
        </div>
    </div>

    <button type="submit" style="margin-top: 15px;">Reset Password</button>
</form>

<script>
    function appendDigit(digit) {
        const input = document.getElementById('otpInput');
        if (input.value.length < 6) {
            input.value += digit;
        }
    }

    function clearInput() {
        document.getElementById('otpInput').value = '';
    }

    function backspace() {
        const input = document.getElementById('otpInput');
        input.value = input.value.slice(0, -1);
    }

    // Block manual OTP typing
    const otpInput = document.getElementById('otpInput');
    otpInput.addEventListener('keydown', e => e.preventDefault());
    otpInput.addEventListener('paste', e => e.preventDefault());

    // Password strength checker
    function checkPasswordStrength() {
        const password = document.getElementById("password").value;

        document.getElementById("length-rule").style.color = password.length >= 8 ? "green" : "red";
        document.getElementById("uppercase-rule").style.color = /[A-Z]/.test(password) ? "green" : "red";
        document.getElementById("lowercase-rule").style.color = /[a-z]/.test(password) ? "green" : "red";
        document.getElementById("number-rule").style.color = /\d/.test(password) ? "green" : "red";
        document.getElementById("special-rule").style.color = /[!@#$%^&*(),.?":{}|<>]/.test(password) ? "green" : "red";
    }

    function validatePassword() {
        const password = document.getElementById("password").value;

        const valid =
            password.length >= 8 &&
            /[A-Z]/.test(password) &&
            /[a-z]/.test(password) &&
            /\d/.test(password) &&
            /[!@#$%^&*(),.?":{}|<>]/.test(password);

        if (!valid) {
            alert("Password does not meet all security requirements.");
        }

        return valid;
    }
</script>
